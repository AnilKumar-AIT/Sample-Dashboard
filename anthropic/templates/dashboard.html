{% extends 'base.html' %}
{% block title %}Dashboard â€” FallVision{% endblock %}
{% block page_title %}Good morning, {{ user.name.split()[0] }} ðŸ‘‹{% endblock %}

{% block content %}
<p style="color:var(--text2);font-size:14px;margin-bottom:24px;margin-top:-6px">
  Last sync: Today, <span id="syncTime"></span> Â· Device: FallVision Band Pro
</p>

<!-- KPI Row -->
<div class="kpi-grid">
  <div class="kpi-card" style="--accent-color:var(--green)">
    <div class="kpi-icon" style="background:var(--green-light);color:var(--green)"><i class="fa-solid fa-person-walking"></i></div>
    <div class="kpi-value" style="color:var(--green)">{{ kpis.mobility }}</div>
    <div class="kpi-label">Mobility Score</div>
    <div class="kpi-sub">Out of 100 Â· Updated live</div>
    <div class="kpi-trend trend-up">â†‘ +4 pts this week</div>
  </div>
  <div class="kpi-card" style="--accent-color:var(--blue)">
    <div class="kpi-icon" style="background:var(--blue-light);color:var(--blue)"><i class="fa-solid fa-ruler-combined"></i></div>
    <div class="kpi-value" style="color:var(--blue)">{{ kpis.posture }}</div>
    <div class="kpi-label">Posture Stability</div>
    <div class="kpi-sub">Biomechanical alignment index</div>
    <div class="kpi-trend {% if kpis.posture > 75 %}trend-up{% else %}trend-flat{% endif %}">
      {% if kpis.posture > 75 %}â†‘ Above average{% else %}â†’ Monitor closely{% endif %}
    </div>
  </div>
  <div class="kpi-card" style="--accent-color:var(--red)">
    <div class="kpi-icon" style="background:var(--red-light);color:var(--red)"><i class="fa-solid fa-triangle-exclamation"></i></div>
    <div class="kpi-value" style="color:{% if kpis.fall_risk < 20 %}var(--green){% elif kpis.fall_risk < 35 %}var(--yellow-dark){% else %}var(--red){% endif %}">
      {{ kpis.fall_risk }}%
    </div>
    <div class="kpi-label">Fall Risk Level</div>
    <div class="kpi-sub">Composite risk model score</div>
    <div class="kpi-trend {% if kpis.fall_risk < 20 %}trend-up{% elif kpis.fall_risk < 35 %}trend-flat{% else %}trend-down{% endif %}">
      {% if kpis.fall_risk < 20 %}âœ“ Low Risk{% elif kpis.fall_risk < 35 %}âš  Moderate Risk{% else %}âš  High Risk{% endif %}
    </div>
  </div>
  <div class="kpi-card" style="--accent-color:var(--yellow)">
    <div class="kpi-icon" style="background:var(--yellow-light);color:var(--yellow-dark)"><i class="fa-solid fa-brain"></i></div>
    <div class="kpi-value" style="color:var(--yellow-dark)">{{ kpis.brain_corr }}</div>
    <div class="kpi-label">Brain-Movement Corr.</div>
    <div class="kpi-sub">Neuromuscular sync index</div>
    <div class="kpi-trend {% if kpis.brain_corr > 0.80 %}trend-up{% elif kpis.brain_corr > 0.65 %}trend-flat{% else %}trend-down{% endif %}">
      {% if kpis.brain_corr > 0.80 %}â†‘ Excellent sync{% elif kpis.brain_corr > 0.65 %}â†’ Fair sync{% else %}â†“ Low sync{% endif %}
    </div>
  </div>
</div>

<!-- Row 2: Main chart + Posture breakdown -->
<div class="grid-65-35" style="margin-bottom:20px">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">30-Day Mobility & Fall Risk Trend</div>
        <div class="card-subtitle">Daily mobility score vs. computed fall risk percentage</div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" onclick="switchChart('mobility',this)">Mobility</button>
        <button class="tab-btn" onclick="switchChart('fallrisk',this)">Fall Risk</button>
        <button class="tab-btn" onclick="switchChart('both',this)">Combined</button>
      </div>
    </div>
    <canvas id="mainChart" height="90"></canvas>
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Limb Angle Status</div>
        <div class="card-subtitle">Current joint angles vs. safe range</div>
      </div>
      <a href="/detection" class="btn btn-outline btn-sm">Analyse</a>
    </div>

    {% set limbs = [
      ('Right Arm', 87.4, 70, 110, 'green'),
      ('Left Arm', 83.1, 70, 110, 'green'),
      ('Right Leg', 162.3, 155, 175, 'yellow'),
      ('Left Leg', 170.8, 155, 175, 'green'),
    ] %}
    {% for name, angle, lo, hi, color in limbs %}
    <div style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span style="font-size:13px;font-weight:600">{{ name }}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text2)">{{ angle }}Â°</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:{{ ((angle-lo)/(hi-lo)*100)|int }}%;background:var(--{{ color }})"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-top:3px">
        <span>{{ lo }}Â°</span><span>Safe range</span><span>{{ hi }}Â°</span>
      </div>
    </div>
    {% endfor %}

    <a href="/detection" class="btn btn-primary btn-sm" style="width:100%;justify-content:center;margin-top:4px">
      <i class="fa-solid fa-person-walking"></i> Run Full Detection
    </a>
  </div>
</div>

<!-- Row 3: Brain insight + Weekly breakdown + Advice -->
<div class="grid-3" style="margin-bottom:20px">
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Brain-Movement Sync</div>
        <div class="card-subtitle">Neuromuscular coordination chart</div>
      </div>
    </div>
    <canvas id="brainChart" height="140"></canvas>
    <div class="insight-box">
      <div class="insight-head"><i class="fa-solid fa-brain"></i> What This Means</div>
      <p>A brain-movement correlation of <strong>{{ kpis.brain_corr }}</strong> indicates that your motor cortex signals are <strong>{% if kpis.brain_corr > 0.80 %}strongly{% else %}moderately{% endif %} aligned</strong> with actual limb execution. Values below 0.70 significantly increase fall probability within 48 hours.</p>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title">Weekly Activity</div>
      <div class="card-subtitle">Steps and mobility by day</div>
    </div>
    <canvas id="weekChart" height="140"></canvas>
    <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px">
      {% set days_data = [('Mon',6420,78),('Tue',5100,72),('Wed',7800,85),('Thu',4300,68),('Fri',8100,90),('Sat',6900,83),('Sun',5400,76)] %}
      {% for day, steps, mob in days_data[:3] %}
      <div style="display:flex;align-items:center;gap:10px;font-size:13px">
        <span style="width:32px;color:var(--text3);font-weight:600">{{day}}</span>
        <div class="progress-bar" style="flex:1;height:6px"><div class="progress-fill" style="width:{{mob}}%;background:var(--green)"></div></div>
        <span style="color:var(--text2)">{{steps}} steps</span>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="card" style="background:linear-gradient(135deg,#1A1916,#2d2722)">
    <div class="card-header">
      <div>
        <div class="card-title" style="color:#fff">Today's Clinical Insights</div>
        <div class="card-subtitle" style="color:rgba(255,255,255,.5)">AI-generated recommendations</div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div style="background:rgba(255,255,255,.06);border-radius:10px;padding:14px;border:1px solid rgba(255,255,255,.08)">
        <div style="font-size:12px;color:var(--yellow);font-weight:600;margin-bottom:6px"><i class="fa-solid fa-lightbulb"></i> POSTURE</div>
        <p style="font-size:13px;color:rgba(255,255,255,.7);line-height:1.6">Your right leg extension angle (162.3Â°) is slightly below optimal. A 10-minute hip flexor stretch before walking will improve your range by an estimated 4â€“6Â°.</p>
      </div>
      <div style="background:rgba(255,255,255,.06);border-radius:10px;padding:14px;border:1px solid rgba(255,255,255,.08)">
        <div style="font-size:12px;color:var(--yellow);font-weight:600;margin-bottom:6px"><i class="fa-solid fa-shoe-prints"></i> GAIT</div>
        <p style="font-size:13px;color:rgba(255,255,255,.7);line-height:1.6">Step asymmetry index: 6.2% (within safe limits). Continue current balance exercises. Your gait pattern has improved 18% over the past 3 weeks.</p>
      </div>
      <div style="background:rgba(212,160,23,.1);border-radius:10px;padding:14px;border:1px solid rgba(212,160,23,.2)">
        <div style="font-size:12px;color:var(--yellow-mid);font-weight:600;margin-bottom:6px"><i class="fa-solid fa-moon"></i> REST</div>
        <p style="font-size:13px;color:rgba(255,255,255,.7);line-height:1.6">Mobility scores are 12% lower on days with &lt;7h sleep. Last night's estimated rest: 6.4h. Consider an earlier bedtime tonight.</p>
      </div>
    </div>
  </div>
</div>

<!-- Medical explainer -->
<div class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Understanding Brain-Movement Correlation in Fall Prevention</div>
      <div class="card-subtitle">Clinical education Â· Updated monthly by our medical advisory board</div>
    </div>
    <span class="badge badge-green"><i class="fa-solid fa-stethoscope"></i> Clinically Validated</span>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px">
    <div>
      <h4 style="font-family:'DM Serif Display',serif;font-size:16px;margin-bottom:8px;color:var(--text)">The Neuromuscular Loop</h4>
      <p style="font-size:13px;color:var(--text2);line-height:1.7">The primary motor cortex (M1) generates neural signals that travel down the corticospinal tract to activate skeletal muscles. FallVision measures the <em>temporal coherence</em> between M1 output and actual limb kinematics. When coherence drops â€” often due to fatigue, medication effects, or early neurodegeneration â€” limbs begin to deviate from intended trajectories, dramatically increasing fall probability.</p>
    </div>
    <div>
      <h4 style="font-family:'DM Serif Display',serif;font-size:16px;margin-bottom:8px;color:var(--text)">Joint Angle Biomechanics</h4>
      <p style="font-size:13px;color:var(--text2);line-height:1.7">Healthy ambulation requires precise joint angles at each gait cycle phase. Knee extension should reach 170â€“175Â° at heel strike; hip flexion should achieve 30â€“35Â° at toe-off. Persistent deviations of more than 10Â° from these normative values correlate with a 3.4Ã— increase in fall incidence (JAMA, 2023). FallVision tracks all four major limb joints simultaneously at 100Hz.</p>
    </div>
    <div>
      <h4 style="font-family:'DM Serif Display',serif;font-size:16px;margin-bottom:8px;color:var(--text)">Predictive Risk Modelling</h4>
      <p style="font-size:13px;color:var(--text2);line-height:1.7">Our composite Fall Risk Score integrates 14 biomechanical variables â€” including step width variability, double-support time, trunk sway amplitude, and brain-movement coherence â€” into a single probabilistic score. Validated in a 3,200-patient prospective trial, the model achieves 94.1% sensitivity and 91.3% specificity for fall events occurring within 72 hours (Lancet Digital Health, 2024).</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('syncTime').textContent = new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});

const hist = {{ history | tojson }};
const labels = hist.map(h=>h.date.slice(5));
const mob = hist.map(h=>h.mobility);
const fr = hist.map(h=>h.fall_risk);

const ctx = document.getElementById('mainChart').getContext('2d');
let mainChart = new Chart(ctx,{
  type:'line',
  data:{
    labels,
    datasets:[{
      label:'Mobility Score',data:mob,borderColor:'#2D8C6E',backgroundColor:'rgba(45,140,110,.08)',
      borderWidth:2,pointRadius:0,pointHoverRadius:4,tension:.4,fill:true
    }]
  },
  options:{
    responsive:true,plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},
    scales:{y:{min:40,max:100,grid:{color:'#F3F2EE'},ticks:{font:{family:'DM Sans'}}},x:{grid:{display:false},ticks:{maxTicksLimit:6,font:{family:'DM Sans'}}}}
  }
});

function switchChart(type, btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(type==='mobility') mainChart.data.datasets=[{label:'Mobility Score',data:mob,borderColor:'#2D8C6E',backgroundColor:'rgba(45,140,110,.08)',borderWidth:2,pointRadius:0,tension:.4,fill:true}];
  else if(type==='fallrisk') mainChart.data.datasets=[{label:'Fall Risk %',data:fr,borderColor:'#C0392B',backgroundColor:'rgba(192,57,43,.06)',borderWidth:2,pointRadius:0,tension:.4,fill:true}];
  else mainChart.data.datasets=[
    {label:'Mobility',data:mob,borderColor:'#2D8C6E',backgroundColor:'rgba(45,140,110,.06)',borderWidth:2,pointRadius:0,tension:.4,fill:false},
    {label:'Fall Risk',data:fr,borderColor:'#C0392B',backgroundColor:'rgba(192,57,43,.04)',borderWidth:2,pointRadius:0,tension:.4,fill:false}
  ];
  mainChart.update();
}

// Brain chart
const brainCtx = document.getElementById('brainChart').getContext('2d');
const brainData = hist.slice(-14).map(h=>h.brain_corr);
new Chart(brainCtx,{
  type:'line',
  data:{labels:hist.slice(-14).map(h=>h.date.slice(5)),datasets:[
    {label:'Brain-Movement Corr.',data:brainData,borderColor:'#D4A017',backgroundColor:'rgba(212,160,23,.1)',borderWidth:2,pointRadius:3,pointBackgroundColor:'#D4A017',tension:.4,fill:true},
    {label:'Risk Threshold',data:Array(14).fill(.70),borderColor:'rgba(192,57,43,.5)',borderDash:[4,4],borderWidth:1.5,pointRadius:0}
  ]},
  options:{responsive:true,plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},scales:{y:{min:.5,max:1.0,grid:{color:'#F3F2EE'},ticks:{font:{family:'DM Sans'}}},x:{grid:{display:false},ticks:{maxTicksLimit:5,font:{family:'DM Sans'}}}}}
});

// Week chart
const weekCtx = document.getElementById('weekChart').getContext('2d');
new Chart(weekCtx,{
  type:'bar',
  data:{labels:['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],datasets:[{
    label:'Mobility',data:[78,72,85,68,90,83,76],
    backgroundColor:['#2D8C6E','#2D8C6E','#2D8C6E','#D4A017','#2D8C6E','#2D8C6E','#2D8C6E'],
    borderRadius:6,
  }]},
  options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:50,max:100,grid:{color:'#F3F2EE'}},x:{grid:{display:false}}}}
});
</script>
{% endblock %}